name: "[PROD] farm-morning Î∞∞Ìè¨"

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  IMAGE_TAG: prod-${{ github.sha }}

jobs:
  setup:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"

      - uses: DeLaGuardo/setup-clojure@9.5
        with:
          cli: 1.11.1.1182

  check:
    runs-on: ubuntu-20.04

    steps:
      - name: Get changed or affected projects
        run: echo "CHANGED_OR_AFFECTED_PROJECTS=$(clojure -M:poly ws get:changes:changed-or-affected-projects)" >> $GITHUB_ENV

      - name: println env
        run: echo $CHANGED_OR_AFFECTED_PROJECTS

  deploy:
    runs-on: ubuntu-20.04

    if: contains(env.CHANGED_OR_AFFECTED_PROJECTS, 'farm-morning')

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Cache maven
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-maven-${{ hashFiles('**/deps.edn') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build uberjar
        run: echo "build and deploy üçã"
